// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  phone     String?
  role      Role     @default(GUEST)
  schoolId  String?
  ngoId     String?  // ← Added for NGO users

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school            School?          @relation("SchoolUsers", fields: [schoolId], references: [id])
  ngo               NGO?             @relation(fields: [ngoId], references: [id])  // ← NGO relation
  orders            Order[]
  assignments       Order[]          @relation("RepAssignments")
  participations    Participation[]
  vehicleAssignments VehicleScrap[] @relation("RepVehicleAssignments")

  @@map("users")
}

model School {
  id        String   @id @default(cuid())
  name      String
  address   String?
  contact   String?
  code      String   @unique  // <-- Add this
  createdAt DateTime @default(now())

  users     User[]   @relation("SchoolUsers")
  events    Event[]

  @@map("schools")
}

model ScrapItem {
  id        String   @id @default(cuid())
  name      String
  unit      Unit     @default(KG)
  basePrice Decimal  @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  orderItems OrderItem[]

  @@map("scrap_items")
}

model NGO {
  id                 String    @id @default(cuid())
  name               String
  slug               String    @unique
  description        String
  logo               String?
  website            String?
  registrationNumber String
  type               NGOType
  address            String
  status             NGOStatus @default(PENDING)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  users              User[]
  orders             Order[]
  events             Event[]

  @@map("ngos")
}

model Order {
  id              String     @id @default(cuid())
  publicId        String     @unique @default(cuid())
  type            OrderType
  status          OrderStatus @default(CREATED)
  estimatedWeight Decimal?
  actualWeight    Decimal?
  pickupAddress   String
  pickupDate      DateTime
  contactName     String
  contactPhone    String
  ngoId           String?
  userId          String?
  repId           String?
  eventId         String?     // ← Add this
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  user     User?      @relation(fields: [userId], references: [id])
  ngo      NGO?       @relation(fields: [ngoId], references: [id])
  rep      User?      @relation("RepAssignments", fields: [repId], references: [id])
  items    OrderItem[]
  event    Event?     @relation(fields: [eventId], references: [id]) // ← Relation

  @@map("orders")
}

model OrderItem {
  id           String   @id @default(cuid())
  orderId      String
  scrapItemId  String
  estimatedQty Decimal
  actualQty    Decimal?

  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  scrapItem ScrapItem @relation(fields: [scrapItemId], references: [id])

  @@map("order_items")
}

model VehicleScrap {
  id            String         @id @default(cuid())
  publicId      String         @unique @default(cuid())
  make          String
  model         String
  year          Int
  condition     String
  phone         String
  location      String
  notes         String?
  status        VehicleStatus  @default(SUBMITTED)
  repId         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // CHANGE THIS LINE — add relation name
  rep           User?          @relation("RepVehicleAssignments", fields: [repId], references: [id])

  @@map("vehicle_scraps")
}

model Event {
  id        String    @id @default(cuid())
  schoolId  String
  name      String
  type      OrderType
  date      DateTime?  // ← Make nullable with ?
  ngoId     String?
  status    EventStatus @default(ONGOING)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  school    School @relation(fields: [schoolId], references: [id])
  ngo       NGO?   @relation(fields: [ngoId], references: [id])
  orders    Order[]
  participations Participation[]

  @@map("events")
}

model Participation {
  id        String   @id @default(cuid())
  studentId String
  eventId   String
  createdAt DateTime @default(now())

  student   User   @relation(fields: [studentId], references: [id])
  event     Event  @relation(fields: [eventId], references: [id])

  @@unique([studentId, eventId]) // Prevent duplicate joins
  @@map("participations")
}

enum Role {
  ADMIN
  REP
  SCHOOL
  STUDENT
  GUEST
  NGO
}

enum Unit {
  KG
  PIECE
}

enum OrderType {
  SELL
  DONATION
}

enum OrderStatus {
  CREATED
  ASSIGNED
  PICKED_UP
  WEIGHED
  COMPLETED
  CANCELLED
}

enum EventStatus {
  ONGOING
  COMPLETED
}

enum VehicleStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  ASSIGNED
  COMPLETED
  REJECTED
}

enum NGOType {
  TRUST
  SOCIETY
  FOUNDATION
  OTHER
}

enum NGOStatus {
  PENDING
  APPROVED
  SUSPENDED
  ARCHIVED
}